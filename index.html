<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>AR Menu experience</title>
    <script src="./dist/mr.js"></script>

    <!-- <script src="https://cdn.jsdelivr.net/npm/mrjs@latest/dist/mr.js"></script>  -->

    <!-- <script src="https://cdn.jsdelivr.net/gh/volumetrics-io/mrjs/dist/mr.js"></script> -->

    <link rel="stylesheet" type="text/css" href="style.css" />
  

</head>

<body>

    <mr-app debug="true" class="app">
        <mr-light color="white" intensity="1" data-position="0 1 0.5"></mr-light>


        <!-- <mr-entity data-position="-0.001 1 0.25"> -->

        <mr-panel id="panel" class="stack" data-comp-anchor="type: plane; label:fixed;" data-position="-0.5 1.5 -1"  style="visibility: hidden;">

            <mr-button class="mr-button" style="z-index: 100;" onclick="togglePanelVisibilityOff()">Close</mr-button>

            <mr-div class="information">
                <mr-div class="tight-stack">
                    <mr-text id="name">loading</mr-text>
                    <mr-text id="cuisine">loading</mr-text>
                </mr-div>
                <mr-text id="desc">loading</mr-text>
                <mr-text id="allergens">loading</mr-text>
                <mr-text id="recipe">loading</mr-text>
                <mr-text id="ingredients">loading</mr-text>
            </mr-div>

            <mr-div class="illustration" >
                <mr-div id="models" data-position="0 0 0"></mr-div>
            </mr-div>

            <!-- <mr-volume id="volume" data-position="0 0 0"> <mr-food id="food"></mr-food> <mr-entity id="food-models"></mr-entity> </mr-volume> -->

        </mr-panel>
    <!-- </mr-entity> -->

        <mr-entity data-comp-anchor="type:plane; label: table;">
            <mr-model class="spbutton" data-position="0.25 0.5 0.5" onclick="App.prev()"
                 src="./buttonprev.glb"></mr-model>
            <mr-model class="spbutton" data-position="-0.25 0.5 0.5" onclick="App.next()"
                 src="./buttonnext.glb"></mr-model>

                 <mr-model id="book" class="test" data-position="-0.001 0.5 0.5" onclick="togglePanelVisibility()"
                src="./assets/book_anim_f.glb"></mr-model>
        </mr-entity>

        <mr-entity data-comp-anchor="type: plane; label: table">
            <!-- <mr-model class="test" data-position="-0.001 -0.25 0.25" onclick="togglePanelVisibility()"
                src="./test.glb"></mr-model> -->
            <!-- <mr-model id="book" class="test" data-position="-0.001 0.25 0.25" onclick="togglePanelVisibility()"
                src="./assets/book_anim_f.glb"></mr-model> -->

        </mr-entity>


        <mr-volume
        id="volume" 
        data-position="0.1 0 0"
        data-comp-anchor="type: plane; label: table;" style="visibility: hidden;">
        <mr-food id="food"></mr-food>
        <mr-entity id="food-models"></mr-entity>
        </mr-volume>


    </mr-app>
</body>


<script>
    /*********** begin: mr-food entity ***********/

    class MRFood extends MREntity {

        constructor() {
            super()

            const geometry = new THREE.BoxGeometry(0.99, 0.99, 0.99);

            const material = new THREE.MeshPhongMaterial({
                // color: '#0235ff',
                // side: 2,
                // transparent: true,
                // opacity: 0,
                // specular: '#7989c4',
                // clipping: true
            })

            this.mesh = new THREE.Mesh(geometry.material)
            this.object3D.add(this.mesh)
        }
    }

    customElements.define('mr-food', MRFood);


    /*********** end: mr-food entity ***********/

    /*********** start: mr.js app code ***********/

    let volume = document.getElementById('volume')
    let panel = document.getElementById('panel')
    let xrButton = document.getElementById('xr-button')

    volume.object3D.visible = false

    let worldPosition = new THREE.Vector3()

    function toggleMR() {
        if (!mrjsUtils.xr.isPresenting) {
            return
        }
        volume.object3D.visible = !volume.object3D.visible
    }

    let food = document.getElementById('food')

    document.addEventListener('anchored', (e) => {

        if (e.target == food.parentElement && e.target.plane) {
            let width = e.target.plane.dimensions.x - 0.01
            let depth = e.target.plane.dimensions.z - 0.01
            let height = width > depth ? width : depth
            height /= 1.5

        }
    })

    document.addEventListener('exitXR', (e) => {
        volume.object3D.visible = false
    })

</script>


<script>
    
    // function togglePanelVisibility() {
    //     var panel = document.getElementById('panel');
     

    //     if (panel.style.visibility === 'hidden' || panel.style.visibility === '') {
    //         panel.style.visibility = 'visible';
    //     } else {
    //         panel.style.visibility = 'hidden';
    //     }
    //     App.render();
    // }

    // function togglePanelVisibilityOff() {
    //     var panel = document.getElementById('panel');
    //     if (panel.style.visibility === 'visible' || panel.style.visibility === ''){
    //         panel.style.visibility = 'hidden';
    //     } else {
    //         panel.style.visibility = 'visible';
    //     }
    // }

    document.addEventListener('DOMContentLoaded', () =>{
        const book = document.getElementById('book');
        book.addEventListener('click', () =>{
            togglePanelVisibility();
        })
    });

</script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const model = document.getElementById('book'); // Adjust this ID to your model's
        let animationAllowed = true; // Flag to control animation playback

        model.addEventListener('click', () => {
            // Check if animation is allowed to play
            if (animationAllowed) {
                // Start the animation
                model.setAttribute('data-comp-animation', 'clip: 0; action: play;');
                animationAllowed = false; // Prevent further animation starts until this one completes

                // Wait for the animation to complete (8333 ms for 250 frames at 30 fps)
                setTimeout(() => {
                    // Use 'pause' or similar to stop the animation, depending on mr.js capabilities
                    model.setAttribute('data-comp-animation', 'clip: 0; action: stop;');

                    animationAllowed = true; // Allow animation to be started again
                }, 8333); // Adjusted duration based on the calculation
            }
        });
    });
</script>

<script>
    // Define togglePanelVisibility and other functions here if not already defined in script.js
    function togglePanelVisibility() {
            var panel = document.getElementById('panel');
            panel.style.visibility = (panel.style.visibility === 'hidden' || panel.style.visibility === '') ? 'visible' : 'hidden';
            App.render(); // Update panel content based on the current state
        }

        function togglePanelVisibilityOff() {
            var panel = document.getElementById('panel');
            panel.style.visibility = 'hidden';
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Setup event listeners or other interactions that depend on the DOM
            const book = document.getElementById('book');
            book.addEventListener('click', togglePanelVisibility);

            // Other DOMContentLoaded-dependent code here
            // This ensures that all DOM elements are fully loaded and accessible
        });

</script>

<script src="script.js"></script>

</html>
